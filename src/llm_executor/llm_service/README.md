# LLM Service - Orchestration Flow

This module implements the LangGraph orchestration flow for the LLM-Driven Secure Python Execution Platform.

## Overview

The orchestration flow manages the complete lifecycle of code generation, validation, correction, and routing:

1. **Input Parsing**: Extracts intent and parameters from natural language queries
2. **Code Generation**: Calls LLM to generate Python code
3. **Validation**: Performs AST-based security validation
4. **Correction**: Sends validation errors back to LLM for code correction (with retry limit)
5. **Routing**: Classifies code and determines execution environment (lightweight vs heavy)

## Architecture

The flow is implemented using LangGraph, which provides:
- State management across nodes
- Conditional routing based on validation results
- Retry logic with configurable limits
- Clear separation of concerns

### Flow Diagram

```
Query → Input Parser → Code Generation → Validation
                                            ↓
                                    [Valid or Invalid?]
                                            ↓
                        ┌───────────────────┴───────────────────┐
                        ↓                                       ↓
                   Valid Code                            Invalid Code
                        ↓                                       ↓
                Execution Router                    Check Retry Limit
                        ↓                                       ↓
                  Classification              ┌─────────────────┴─────────────┐
                (Lightweight/Heavy)           ↓                               ↓
                        ↓                 Correction                   Max Retries
                      END              (back to Validation)                  END
```

## Usage

### Basic Usage

```python
from llm_executor.llm_service.orchestration import LLMOrchestrationFlow

# Create the flow
flow = LLMOrchestrationFlow()

# Execute a query
result = flow.execute(
    query="Calculate the sum of numbers from 1 to 100",
    max_retries=3
)

# Check results
if result["validation_result"].is_valid:
    print(f"Generated code: {result['generated_code']}")
    print(f"Classification: {result['classification']}")
else:
    print(f"Validation failed: {result['validation_result'].errors}")
```

### With Custom LLM Client

```python
from llm_executor.llm_service.orchestration import LLMOrchestrationFlow

# Create flow with custom LLM client
llm_client = YourLLMClient()
flow = LLMOrchestrationFlow(llm_client=llm_client)

# Execute
result = flow.execute(query="Your query here", max_retries=3)
```

## State Management

The flow maintains a `GraphState` with the following fields:

- `query`: Original natural language query
- `generated_code`: Python code generated by LLM
- `validation_result`: Result of code validation
- `validation_attempts`: Number of validation retry attempts
- `max_retries`: Maximum allowed retry attempts
- `classification`: Code complexity classification (lightweight/heavy)
- `error`: Error message if any
- `status`: Current flow status

## Nodes

### InputParserNode
Extracts intent and parameters from natural language queries.

### CodeGenerationNode
Calls LLM with structured prompts to generate Python code.

### CodeValidatorNode
Invokes the CodeValidator to perform AST-based security validation.

### CorrectionNode
Sends validation errors back to LLM for code correction with retry limit.

### ExecutionRouterNode
Uses CodeClassifier to determine execution environment (lightweight vs heavy).

## Validation and Correction

The flow automatically handles validation failures:

1. If code fails validation, the correction node is invoked
2. Validation errors are sent back to the LLM
3. LLM generates corrected code
4. Process repeats until code is valid or max retries reached
5. If max retries exceeded, flow terminates with error

## Testing

The module includes comprehensive property-based tests:

- **Property 1**: Validation precedes execution
- **Property 2**: Validation errors trigger correction
- **Property 7**: Valid code proceeds to routing
- **Property 23**: Validation retry limit is enforced

Run tests:
```bash
pytest tests/test_properties/test_orchestration_properties.py -v
```

## Integration

The orchestration flow integrates with:

- **CodeValidator**: AST-based security validation
- **CodeClassifier**: Complexity classification for routing
- **LLM Client**: Code generation and correction (pluggable)

## Future Enhancements

- Support for streaming responses
- Advanced prompt engineering
- Caching of validated code patterns
- Metrics and observability hooks
- Custom validation rules per query type
